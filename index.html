<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spells Protocol V4 | The AI App Engine</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’ </text></svg>">

    <!-- Core Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        obsidian: '#050505',
                        charcoal: '#0F0F12',
                        glass: 'rgba(255, 255, 255, 0.03)',
                        neon: '#6366f1',
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                    }
                }
            }
        }
    </script>

    <style>
        /* BASE AESTHETICS */
        body { background-color: #050505; color: #e4e4e7; overflow-x: hidden; }
        
        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }

        /* NEURAL CANVAS */
        #neuralCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0.6;
        }

        /* GLASSMORPHISM UTILITIES */
        .glass-panel {
            background: rgba(15, 15, 18, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* SPOTLIGHT EFFECT */
        .spotlight-group:hover .spotlight { opacity: 1; }
        .spotlight {
            background: radial-gradient(600px circle at var(--x) var(--y), rgba(99, 102, 241, 0.15), transparent 40%);
            z-index: 1;
        }

        /* TYPING ANIMATION */
        .typing-cursor::after { content: '|'; animation: blink 1s step-start infinite; color: #6366f1; }
        @keyframes blink { 50% { opacity: 0; } }

        /* UTILITIES */
        .text-glow { text-shadow: 0 0 20px rgba(99, 102, 241, 0.5); }
        .fade-enter { animation: fadeIn 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased selection:bg-indigo-500/30">

    <!-- 1. DYNAMIC BACKGROUND -->
    <canvas id="neuralCanvas"></canvas>
    
    <!-- Background Glows -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-0 left-1/4 w-[500px] h-[500px] bg-indigo-600/10 rounded-full blur-[128px]"></div>
        <div class="absolute bottom-0 right-1/4 w-[600px] h-[600px] bg-purple-600/5 rounded-full blur-[128px]"></div>
    </div>

    <!-- 2. MAIN LAYOUT -->
    <div class="relative z-10 flex h-screen overflow-hidden">
        
        <!-- SIDEBAR NAVIGATION -->
        <aside class="w-20 lg:w-72 flex-shrink-0 flex flex-col justify-between border-r border-white/5 bg-charcoal/50 backdrop-blur-xl z-50 transition-all duration-300">
            <div>
                <!-- Brand -->
                <div class="h-20 flex items-center justify-center lg:justify-start lg:px-8 border-b border-white/5">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                        <i data-lucide="cpu" class="text-white w-6 h-6"></i>
                    </div>
                    <div class="hidden lg:block ml-4">
                        <h1 class="font-bold text-white tracking-tight text-lg">SPELLS</h1>
                        <p class="text-[10px] text-gray-500 font-mono tracking-widest uppercase">Protocol V4</p>
                    </div>
                </div>

                <!-- Menu -->
                <nav class="mt-8 space-y-2 px-2 lg:px-4">
                    <button onclick="switchTab('home')" id="nav-home" class="nav-btn active w-full flex items-center gap-4 px-3 lg:px-4 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                        <i data-lucide="home" class="w-5 h-5 group-hover:text-indigo-400 transition-colors"></i>
                        <span class="hidden lg:block">Overview</span>
                    </button>
                    <button onclick="switchTab('marketplace')" id="nav-marketplace" class="nav-btn w-full flex items-center gap-4 px-3 lg:px-4 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                        <i data-lucide="grid" class="w-5 h-5 group-hover:text-indigo-400 transition-colors"></i>
                        <span class="hidden lg:block">Marketplace</span>
                    </button>
                    <button onclick="switchTab('builder')" id="nav-builder" class="nav-btn w-full flex items-center gap-4 px-3 lg:px-4 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                        <i data-lucide="sparkles" class="w-5 h-5 group-hover:text-indigo-400 transition-colors"></i>
                        <span class="hidden lg:block">Laboratory</span>
                    </button>
                    <button onclick="switchTab('docs')" id="nav-docs" class="nav-btn w-full flex items-center gap-4 px-3 lg:px-4 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                        <i data-lucide="book-open" class="w-5 h-5 group-hover:text-indigo-400 transition-colors"></i>
                        <span class="hidden lg:block">Documentation</span>
                    </button>
                </nav>
            </div>

            <!-- Wallet Connection -->
            <div class="p-4 border-t border-white/5">
                <button id="connectBtn" onclick="openWalletSelect()" class="w-full py-3 bg-white text-black hover:bg-gray-200 rounded-xl font-bold text-sm transition shadow-lg shadow-white/5 flex items-center justify-center gap-2">
                    <i data-lucide="wallet" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">Connect</span>
                </button>
                <div class="mt-4 hidden lg:flex items-center justify-center gap-2 text-[10px] text-gray-500 font-mono uppercase">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    Monad Devnet
                </div>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main id="mainContainer" class="flex-1 overflow-y-auto scroll-smooth relative" onmousemove="handleSpotlight(event)">
            
            <!-- VIEW 1: HOME / LANDING -->
            <section id="view-home" class="min-h-full">
                <!-- Hero -->
                <div class="relative pt-32 pb-20 px-8 md:px-16 max-w-7xl mx-auto">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 text-indigo-400 text-xs font-mono mb-6 fade-enter">
                        <span class="w-2 h-2 rounded-full bg-indigo-500"></span> V4 ENGINE ONLINE
                    </div>
                    
                    <h1 class="text-5xl md:text-7xl font-bold text-white mb-6 leading-tight fade-enter" style="animation-delay: 0.1s">
                        The Infinite <br> 
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 text-glow">App Engine.</span>
                    </h1>
                    
                    <p class="text-xl text-gray-400 max-w-2xl mb-10 leading-relaxed fade-enter" style="animation-delay: 0.2s">
                        Spells Protocol allows you to generate, deploy, and trade full-stack applications entirely on-chain. No servers. No IPFS. Just pure bytecode.
                    </p>

                    <div class="flex gap-4 fade-enter" style="animation-delay: 0.3s">
                        <button onclick="switchTab('marketplace')" class="px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition shadow-lg shadow-indigo-500/20 flex items-center gap-2">
                            Explore Apps <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                        <button onclick="switchTab('docs')" class="px-8 py-4 bg-white/5 hover:bg-white/10 text-white border border-white/10 rounded-xl font-bold transition">
                            Read Docs
                        </button>
                    </div>
                </div>

                <!-- Features Grid (Visible without Wallet) -->
                <div class="px-8 md:px-16 max-w-7xl mx-auto pb-32">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-panel p-8 rounded-2xl spotlight-group relative overflow-hidden">
                            <div class="spotlight absolute -inset-px opacity-0 transition-opacity duration-300"></div>
                            <div class="relative z-10">
                                <div class="w-12 h-12 bg-indigo-500/10 rounded-lg flex items-center justify-center mb-6 border border-indigo-500/20">
                                    <i data-lucide="cpu" class="text-indigo-400 w-6 h-6"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white mb-2">AI Generation</h3>
                                <p class="text-gray-400 text-sm leading-relaxed">Describe any functionality in plain English. The protocol constructs the HTML, CSS, and JS logic instantly.</p>
                            </div>
                        </div>
                        <div class="glass-panel p-8 rounded-2xl spotlight-group relative overflow-hidden">
                            <div class="spotlight absolute -inset-px opacity-0 transition-opacity duration-300"></div>
                            <div class="relative z-10">
                                <div class="w-12 h-12 bg-emerald-500/10 rounded-lg flex items-center justify-center mb-6 border border-emerald-500/20">
                                    <i data-lucide="database" class="text-emerald-400 w-6 h-6"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white mb-2">SSTORE2 Storage</h3>
                                <p class="text-gray-400 text-sm leading-relaxed">Code is compressed via LZ-String and stored directly in contract bytecode. 100% immutable and censorship resistant.</p>
                            </div>
                        </div>
                        <div class="glass-panel p-8 rounded-2xl spotlight-group relative overflow-hidden">
                            <div class="spotlight absolute -inset-px opacity-0 transition-opacity duration-300"></div>
                            <div class="relative z-10">
                                <div class="w-12 h-12 bg-purple-500/10 rounded-lg flex items-center justify-center mb-6 border border-purple-500/20">
                                    <i data-lucide="globe" class="text-purple-400 w-6 h-6"></i>
                                </div>
                                <h3 class="text-xl font-bold text-white mb-2">Browser Runtime</h3>
                                <p class="text-gray-400 text-sm leading-relaxed">Apps run in a secure sandbox but maintain a bridge to the user's wallet for signing transactions and DeFi interactions.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW 2: MARKETPLACE -->
            <section id="view-marketplace" class="hidden min-h-full p-8 md:p-16">
                <div class="max-w-7xl mx-auto">
                    <div class="flex justify-between items-end mb-12">
                        <div>
                            <h2 class="text-4xl font-bold text-white mb-2">Registry.</h2>
                            <p class="text-gray-400">Discover decentralized intelligence.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="filterCategory('All')" class="px-4 py-2 text-xs font-bold rounded-lg bg-white text-black">ALL</button>
                            <button onclick="filterCategory('Game')" class="px-4 py-2 text-xs font-bold rounded-lg bg-white/5 text-gray-400 hover:text-white border border-white/5">GAMES</button>
                            <button onclick="filterCategory('DeFi')" class="px-4 py-2 text-xs font-bold rounded-lg bg-white/5 text-gray-400 hover:text-white border border-white/5">DEFI</button>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="relative mb-8">
                        <i data-lucide="search" class="absolute left-4 top-3.5 text-gray-500 w-5 h-5"></i>
                        <input id="searchBar" onkeyup="filterApps()" type="text" placeholder="Search by name, hash, or creator..." class="w-full bg-white/5 border border-white/10 rounded-xl py-3 pl-12 pr-4 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition">
                    </div>

                    <!-- The Grid -->
                    <div id="appGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Content injected via JS -->
                        <div class="col-span-full py-20 text-center border border-dashed border-white/10 rounded-2xl">
                            <p class="text-gray-500">Connecting to Blockchain Node...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW 3: BUILDER -->
            <section id="view-builder" class="hidden min-h-full p-8 md:p-12">
                <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <!-- Config Panel -->
                    <div class="glass-panel p-8 rounded-2xl h-fit">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                            <i data-lucide="terminal" class="text-indigo-400"></i> Construction Kit
                        </h2>
                        
                        <!-- Form -->
                        <div class="space-y-6">
                            <input type="hidden" id="updateId"><input type="hidden" id="tempCode"><input type="hidden" id="tempIcon">
                            
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Application Name</label>
                                <input id="buildName" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg text-white focus:border-indigo-500 outline-none" placeholder="e.g. Neural Dex">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">System Prompt</label>
                                <textarea id="buildPrompt" rows="6" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg text-white font-mono text-sm focus:border-indigo-500 outline-none" placeholder="Describe functionality. E.g. 'A dark mode tetris game that speeds up every 100 points.'"></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Category</label>
                                    <select id="buildCategory" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg text-white outline-none">
                                        <option value="Game">Game</option>
                                        <option value="DeFi">DeFi</option>
                                        <option value="Tool">Utility</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">List Price (MON)</label>
                                    <input id="buildPrice" type="number" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg text-white outline-none" placeholder="0.00">
                                </div>
                            </div>

                            <div id="compileStatus" class="hidden p-4 rounded-lg font-mono text-xs"></div>

                            <div class="flex gap-4 pt-4">
                                <button id="genBtn" onclick="generatePreview()" class="flex-1 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition">Generate v1.0</button>
                                <button id="mintBtn" onclick="mintCurrentPreview()" class="hidden flex-1 py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold transition">Deploy on Monad</button>
                            </div>
                        </div>
                    </div>

                    <!-- Preview / Docs -->
                    <div class="space-y-6">
                        <div class="p-6 border border-white/10 rounded-2xl bg-white/5">
                            <h3 class="font-bold text-white mb-2">Prompt Engineering Guide</h3>
                            <ul class="space-y-3 text-sm text-gray-400">
                                <li class="flex gap-2"><i data-lucide="check-circle" class="text-emerald-500 w-4"></i> Be specific about visual style (e.g. "Cyberpunk aesthetics").</li>
                                <li class="flex gap-2"><i data-lucide="check-circle" class="text-emerald-500 w-4"></i> Mention libraries ("Use Ethers.js for wallet connection").</li>
                                <li class="flex gap-2"><i data-lucide="check-circle" class="text-emerald-500 w-4"></i> Ask for error handling ("Handle web3 connection errors gracefully").</li>
                            </ul>
                        </div>
                        
                        <!-- Terminal Output Visual -->
                        <div class="p-6 bg-black border border-white/10 rounded-2xl font-mono text-xs text-gray-500 h-64 overflow-hidden relative">
                            <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-transparent to-black/80 pointer-events-none"></div>
                            <p>> Initializing Builder Environment...</p>
                            <p>> Connecting to Gemini 1.5 Flash...</p>
                            <p>> Ready for input_</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW 4: DOCS -->
            <section id="view-docs" class="hidden min-h-full p-8 md:p-16 max-w-5xl mx-auto">
                <div class="mb-12 border-b border-white/10 pb-8">
                    <h1 class="text-5xl font-bold text-white mb-4">Documentation</h1>
                    <p class="text-xl text-gray-400">Technical reference for Spells Protocol V4.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                    <!-- TOC -->
                    <div class="hidden lg:block space-y-4 text-sm text-gray-500 sticky top-8">
                        <p class="text-white font-bold mb-4 uppercase tracking-widest text-xs">Contents</p>
                        <a href="#" class="block hover:text-indigo-400 transition">Introduction</a>
                        <a href="#" class="block hover:text-indigo-400 transition">SSTORE2 Architecture</a>
                        <a href="#" class="block hover:text-indigo-400 transition">Runtime Sandbox</a>
                        <a href="#" class="block hover:text-indigo-400 transition">Contract Addresses</a>
                    </div>

                    <!-- Content -->
                    <div class="lg:col-span-2 space-y-12">
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-4">Architecture</h3>
                            <p class="text-gray-400 leading-relaxed mb-6">
                                Traditional NFTs store metadata on IPFS, which is mutable and can go offline. Spells Protocol stores the entire application logic (HTML/JS) directly in the Monad Blockchain State Trie using <code class="bg-white/10 px-1 rounded text-indigo-300">SSTORE2</code>.
                            </p>
                            <div class="bg-black/50 p-4 rounded-xl border border-white/10 font-mono text-xs text-gray-300 overflow-x-auto">
                                // Solidity Interface<br>
                                function getCode(uint256 tokenId) external view returns (string memory) {<br>
                                &nbsp;&nbsp;address pointer = sstore2Pointers[tokenId];<br>
                                &nbsp;&nbsp;return SSTORE2.read(pointer);<br>
                                }
                            </div>
                        </div>

                        <div>
                            <h3 class="text-2xl font-bold text-white mb-4">Runtime Sandbox</h3>
                            <p class="text-gray-400 leading-relaxed">
                                When a user launches an application, the browser fetches the bytecode, decompresses it using <code class="text-white">LZ-String</code>, and injects it into an isolated iframe. The protocol injects a secure bridge to expose <code class="text-white">window.ethereum</code> to the sandboxed app.
                            </p>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- APP RUNNER OVERLAY -->
    <div id="appWindow" class="fixed inset-0 z-[100] bg-[#050505] hidden flex flex-col transition-opacity duration-300">
        <div class="h-14 border-b border-white/5 bg-[#0F0F12] flex justify-between items-center px-6">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-sm font-mono text-gray-400 tracking-widest uppercase" id="appWindowTitle">Runtime Environment</span>
            </div>
            <button onclick="closeAppWindow()" class="text-xs bg-red-500/10 text-red-400 px-4 py-2 rounded-lg hover:bg-red-500/20 transition">Terminate Process</button>
        </div>
        <div class="flex-1 relative">
            <iframe id="appFrame" class="w-full h-full border-none bg-white"></iframe>
        </div>
    </div>

    <!-- WALLET MODAL -->
    <div id="walletModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel p-8 rounded-2xl w-96 shadow-2xl transform transition-all scale-95">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Connect Wallet</h3>
                <button onclick="closeWalletSelect()" class="text-gray-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <button onclick="selectWallet('metamask')" class="w-full bg-white/5 hover:bg-white/10 border border-white/5 p-4 rounded-xl flex items-center justify-between mb-3 transition group">
                <span class="font-bold text-gray-300 group-hover:text-white">MetaMask</span>
                <div class="w-3 h-3 bg-orange-500 rounded-full shadow-[0_0_10px_orange]"></div>
            </button>
            <button onclick="selectWallet('phantom')" class="w-full bg-white/5 hover:bg-white/10 border border-white/5 p-4 rounded-xl flex items-center justify-between transition group">
                <span class="font-bold text-gray-300 group-hover:text-white">Phantom</span>
                <div class="w-3 h-3 bg-purple-500 rounded-full shadow-[0_0_10px_purple]"></div>
            </button>
        </div>
    </div>

    <script>
        // --- 1. NEURAL NETWORK BACKGROUND ---
        const canvas = document.getElementById('neuralCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, nodes = [];
        const mouse = { x: null, y: null, radius: 150 };

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; initNodes(); }
        window.addEventListener('resize', resize);
        window.addEventListener('mousemove', (e) => { mouse.x = e.x; mouse.y = e.y; });

        function initNodes() {
            nodes = [];
            const density = Math.floor(width * height / 15000); // Calc density based on screen
            for(let i=0; i<density; i++){
                nodes.push({
                    x: Math.random() * width, y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2
                });
            }
        }

        function animateNodes() {
            ctx.clearRect(0,0,width,height);
            ctx.fillStyle = '#6366f1'; // Indigo nodes
            ctx.strokeStyle = '#6366f1';
            
            nodes.forEach(node => {
                node.x += node.vx; node.y += node.vy;
                if(node.x < 0 || node.x > width) node.vx *= -1;
                if(node.y < 0 || node.y > height) node.vy *= -1;

                // Draw Node
                ctx.globalAlpha = 0.5;
                ctx.beginPath(); ctx.arc(node.x, node.y, node.size, 0, Math.PI*2); ctx.fill();

                // Draw Connections
                nodes.forEach(other => {
                    const dx = node.x - other.x;
                    const dy = node.y - other.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if(dist < 100) {
                        ctx.globalAlpha = (1 - dist/100) * 0.2;
                        ctx.lineWidth = 0.5;
                        ctx.beginPath(); ctx.moveTo(node.x, node.y); ctx.lineTo(other.x, other.y); ctx.stroke();
                    }
                });

                // Mouse Interaction
                const mdx = mouse.x - node.x;
                const mdy = mouse.y - node.y;
                const mdist = Math.sqrt(mdx*mdx + mdy*mdy);
                if(mdist < mouse.radius) {
                    ctx.globalAlpha = (1 - mdist/mouse.radius) * 0.5;
                    ctx.beginPath(); ctx.moveTo(node.x, node.y); ctx.lineTo(mouse.x, mouse.y); ctx.stroke();
                }
            });
            requestAnimationFrame(animateNodes);
        }
        initNodes(); animateNodes();

        // --- 2. UI LOGIC ---
        lucide.createIcons();
        
        // Spotlight Effect
        function handleSpotlight(e) {
            document.querySelectorAll('.spotlight').forEach(el => {
                const rect = el.parentElement.getBoundingClientRect();
                el.style.setProperty('--x', (e.clientX - rect.left) + 'px');
                el.style.setProperty('--y', (e.clientY - rect.top) + 'px');
            });
        }

        function switchTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            
            // Nav State
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('text-white', 'bg-white/5');
                b.classList.add('text-gray-400');
            });
            const activeBtn = document.getElementById(`nav-${id}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-gray-400');
                activeBtn.classList.add('text-white', 'bg-white/5');
            }

            if(id === 'marketplace') loadMarketplace();
        }

        // --- 3. WEB3 & APP ENGINE ---
        const CONTRACT_ADDRESS = "0x53830d0F28182e0EB8F1C563AC67C6eDD0cD301b";
        const ABI = ["function appCount() view returns (uint256)", "function createApp(string, string, string, string, uint256) public payable", "function buyApp(uint256) public payable", "function getAppInfo(uint256) view returns (string, uint256, address, string, string, uint256)", "function hasAccess(uint256, address) view returns (bool)", "function getCode(uint256) view returns (string)"];
        let provider, signer, contract, userAddress;

        function openWalletSelect() { document.getElementById('walletModal').classList.remove('hidden'); }
        function closeWalletSelect() { document.getElementById('walletModal').classList.add('hidden'); }

        async function selectWallet(type) {
            closeWalletSelect();
            try {
                const p = type === 'metamask' ? window.ethereum : window.phantom?.ethereum;
                if(!p) return alert("Wallet not detected.");
                
                provider = new ethers.providers.Web3Provider(p);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                document.getElementById('connectBtn').innerHTML = `<i data-lucide="user" class="w-4 h-4"></i> ${userAddress.slice(0,6)}...`;
                
                // Refresh views if they are open
                if(!document.getElementById('view-marketplace').classList.contains('hidden')) loadMarketplace();
            } catch(e) { console.error(e); }
        }

        async function loadMarketplace() {
            const grid = document.getElementById('appGrid');
            
            // If not connected, show dummy data or lock screen (User preference: Show content but lock actions)
            if(!contract) {
                // Show "Locked" state for now as requested by user logic
                grid.innerHTML = `
                <div class="col-span-full py-24 text-center border border-dashed border-white/10 rounded-2xl bg-white/5">
                    <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 border border-white/10"><i data-lucide="lock" class="text-gray-500"></i></div>
                    <h3 class="text-xl font-bold text-white">Wallet Connection Required</h3>
                    <p class="text-gray-500 mt-2">Connect to Monad Devnet to access the registry.</p>
                </div>`;
                lucide.createIcons();
                return;
            }

            grid.innerHTML = `<div class="col-span-full text-center py-20 animate-pulse text-indigo-400">Syncing with Chain...</div>`;
            
            try {
                const count = await contract.appCount();
                let html = "";
                for(let i=1; i<=count; i++) {
                    const info = await contract.getAppInfo(i);
                    const isOwned = await contract.hasAccess(i, userAddress);
                    const isCreator = info[2].toLowerCase() === userAddress.toLowerCase();
                    
                    let icon = '<div class="text-3xl">ðŸ’ </div>';
                    try { if(info[3]) icon = LZString.decompressFromBase64(info[3]) || icon; } catch(e){}

                    html += `
                    <div class="glass-panel p-5 rounded-2xl spotlight-group relative group hover:-translate-y-1 transition duration-300">
                        <div class="spotlight absolute -inset-px opacity-0 transition-opacity duration-300 rounded-2xl"></div>
                        <div class="relative z-10">
                            <div class="h-40 bg-black/40 rounded-xl mb-4 flex items-center justify-center border border-white/5 group-hover:border-indigo-500/30 transition overflow-hidden">
                                <div class="scale-100 group-hover:scale-110 transition-transform duration-500">${icon}</div>
                            </div>
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-white text-lg truncate">${info[0]}</h3>
                                <span class="text-[10px] bg-white/10 px-2 py-1 rounded text-gray-400 uppercase">${info[4] || 'App'}</span>
                            </div>
                            <p class="text-xs text-gray-500 font-mono mb-4">DEV: ${info[2].slice(0,6)}...</p>
                            <div class="flex gap-2">
                                ${isOwned || isCreator
                                    ? `<button onclick="launchApp(${i}, '${info[0]}', true)" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg font-bold text-sm transition">Launch</button>`
                                    : `<button onclick="buyApp(${i}, '${ethers.utils.formatEther(info[1])}')" class="flex-1 bg-white hover:bg-gray-200 text-black py-2 rounded-lg font-bold text-sm transition flex justify-between px-4"><span>Buy</span><span>${ethers.utils.formatEther(info[1])} MON</span></button>`
                                }
                            </div>
                        </div>
                    </div>`;
                }
                grid.innerHTML = html || `<div class="col-span-full text-center text-gray-500">Registry Empty.</div>`;
                lucide.createIcons();
            } catch(e) { grid.innerHTML = `<div class="col-span-full text-red-500 text-center">${e.message}</div>`; }
        }

        // --- 4. BUILDER & LAUNCHER (FIXED) ---
        
        async function generatePreview() {
            const name = document.getElementById('buildName').value;
            const prompt = document.getElementById('buildPrompt').value;
            const status = document.getElementById('compileStatus');
            
            if(!name || !prompt) return alert("Please fill in Name and Prompt.");
            
            status.classList.remove('hidden');
            status.innerHTML = `<span class="animate-pulse text-indigo-400">> Sending instructions to Neural Core...</span>`;
            status.className = "p-4 bg-indigo-900/20 border border-indigo-500/30 rounded-lg font-mono text-xs text-indigo-300";

            try {
                const res = await fetch("/api/chat", {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ prompt: `App:${name}. Req:${prompt}`, message: "Generate V3 JSON" })
                });
                const data = await res.json();
                if(!data.reply?.code) throw new Error("AI Generation failed.");

                // Store for minting
                document.getElementById("tempCode").value = LZString.compressToBase64(data.reply.code);
                document.getElementById("tempIcon").value = LZString.compressToBase64(data.reply.icon || "");

                // Launch Local Preview
                launchApp(null, `PREVIEW: ${name}`, false, data.reply.code);
                
                // Update UI
                document.getElementById("genBtn").classList.add("hidden");
                document.getElementById("mintBtn").classList.remove("hidden");
                status.innerHTML = `<span class="text-emerald-400">> Compilation Successful. Ready to Deploy.</span>`;
                status.className = "p-4 bg-emerald-900/20 border border-emerald-500/30 rounded-lg font-mono text-xs text-emerald-300";

            } catch(e) {
                status.innerHTML = `<span class="text-red-400">> Error: ${e.message}</span>`;
            }
        }

        async function mintCurrentPreview() {
            if(!contract) return openWalletSelect();
            try {
                const tx = await contract.createApp(
                    document.getElementById("buildName").value,
                    document.getElementById("tempCode").value,
                    document.getElementById("tempIcon").value,
                    document.getElementById("buildCategory").value,
                    ethers.utils.parseEther(document.getElementById("buildPrice").value || "0"),
                    { value: ethers.utils.parseEther("50") }
                );
                await tx.wait();
                alert("Deployment Successful!");
                switchTab('marketplace');
            } catch(e) { alert(e.message); }
        }

        // FIXED LAUNCH FUNCTION
        async function launchApp(id, title, isBlockchain, rawCode = null) {
            const win = document.getElementById('appWindow');
            const frame = document.getElementById('appFrame');
            
            win.classList.remove('hidden');
            document.getElementById('appWindowTitle').innerText = title;
            
            let codeToRun = rawCode;

            if (isBlockchain && id !== null) {
                try {
                    const compressed = await contract.getCode(id);
                    if(!compressed) throw new Error("No code found on-chain.");
                    codeToRun = LZString.decompressFromBase64(compressed);
                } catch(e) {
                    alert("Blockchain Read Error: " + e.message);
                    closeAppWindow();
                    return;
                }
            }

            // Bridge Script to inject Web3
            const bridge = `
                <style>
                    ::-webkit-scrollbar { width: 0px; }
                    body { margin: 0; overflow: hidden; background: #fff; }
                    #start-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; color: #0f0; font-family: monospace; cursor: pointer; }
                </style>
                <div id="start-overlay" onclick="this.remove()">[ CLICK TO INITIALIZE SYSTEM ]</div>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"><\/script>
                <script>
                    window.ethereum = window.parent.ethereum;
                    window.ethers = window.parent.ethers;
                    console.log("Bridge Established.");
                <\/script>
            `;

            // Reset and Write
            frame.srcdoc = bridge + codeToRun;
        }

        function closeAppWindow() {
            document.getElementById('appWindow').classList.add('hidden');
            document.getElementById('appFrame').srcdoc = "";
        }

        function buyApp(id, price) {
            contract.buyApp(id, {value: ethers.utils.parseEther(price)})
            .then(tx => tx.wait())
            .then(() => loadMarketplace())
            .catch(e => alert(e.message));
        }
    </script>
</body>
</html>
