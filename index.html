<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spells Protocol | AI App Engine</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✨</text></svg>">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Modern Typography: Inter & JetBrains Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        background: '#09090b',
                        surface: '#18181b',
                        border: '#27272a',
                        primary: '#6366f1', /* Indigo */
                        secondary: '#8b5cf6', /* Violet */
                        accent: '#10b981', /* Emerald */
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* CORE STYLES */
        body {
            background-color: theme('colors.background');
            color: #e4e4e7;
            overflow: hidden; /* For app-like feel */
        }

        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* ANIMATED BACKGROUND */
        #bgCanvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
            opacity: 0.4;
        }

        /* SCROLL REVEAL UTILITY */
        .reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s cubic-bezier(0.5, 0, 0, 1);
        }
        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* GLASSMORPHISM CARD */
        .glass-card {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            border-color: rgba(99, 102, 241, 0.5); /* Primary Color */
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        /* NAVIGATION */
        .nav-item {
            position: relative;
            transition: all 0.2s;
            border-left: 2px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99,102,241,0.1) 0%, transparent 100%);
            border-left-color: #6366f1;
            color: white;
        }

        /* TYPEWRITER CURSOR */
        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-start infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* GRADIENT TEXT */
        .text-gradient {
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body>

    <!-- Background -->
    <canvas id="bgCanvas"></canvas>

    <!-- App Wrapper -->
    <div class="relative z-10 flex w-screen h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <aside class="w-72 bg-black/50 border-r border-white/5 backdrop-blur-xl flex flex-col justify-between hidden md:flex">
            <div>
                <!-- Brand -->
                <div class="p-8 pb-4">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold">S</div>
                        <h1 class="text-xl font-bold tracking-tight text-white">SPELLS</h1>
                    </div>
                    <p class="text-xs text-gray-500 font-mono ml-11">PROTOCOL V4</p>
                </div>

                <!-- Menu -->
                <nav class="mt-6 px-4 space-y-1">
                    <button onclick="switchTab('marketplace')" id="nav-marketplace" class="nav-item active w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-400 rounded-r-lg">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i> Marketplace
                    </button>
                    <button onclick="switchTab('builder')" id="nav-builder" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-400 rounded-r-lg">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> AI Laboratory
                    </button>
                    <button onclick="openMyProfile()" id="nav-profile" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-400 rounded-r-lg">
                        <i data-lucide="user-circle" class="w-4 h-4"></i> Profile
                    </button>
                    <button onclick="switchTab('docs')" id="nav-docs" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-400 rounded-r-lg">
                        <i data-lucide="book" class="w-4 h-4"></i> Documentation
                    </button>
                </nav>
            </div>

            <!-- Connect -->
            <div class="p-4 border-t border-white/5">
                <button id="connectBtn" onclick="openWalletSelect()" class="w-full py-3 px-4 bg-white text-black hover:bg-gray-200 rounded-lg text-sm font-semibold transition shadow-lg flex items-center justify-center gap-2">
                    Connect Wallet
                </button>
                <div class="flex items-center justify-between mt-4 px-2">
                    <span class="text-xs text-gray-600">Status</span>
                    <span id="networkStatus" class="flex items-center gap-1.5 text-xs text-emerald-500">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Online
                    </span>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto scroll-smooth">
            <div class="max-w-7xl mx-auto p-8 md:p-12 pb-32">
                
                <!-- TOP BAR -->
                <div class="flex justify-between items-center mb-16 reveal active">
                    <div class="relative w-96">
                        <i data-lucide="search" class="absolute left-3 top-3 text-gray-500 w-4 h-4"></i>
                        <input id="searchBar" onkeyup="filterApps()" type="text" placeholder="Search spells..." class="w-full bg-surface border border-white/10 rounded-lg pl-10 pr-4 py-2.5 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none transition text-white">
                    </div>
                    <div class="flex items-center gap-4">
                        <a href="#" class="text-gray-400 hover:text-white transition"><i data-lucide="github" class="w-5 h-5"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white transition"><i data-lucide="twitter" class="w-5 h-5"></i></a>
                    </div>
                </div>

                <!-- VIEW: MARKETPLACE -->
                <section id="view-marketplace" class="animate-fade-in block">
                    <div class="mb-12">
                        <!-- Typewriter Header -->
                        <h2 class="text-4xl md:text-5xl font-bold mb-4 text-gradient typing-target" data-text="Discover Intelligent Applications."></h2>
                        <p class="text-gray-400 max-w-2xl text-lg reveal">Decentralized, immutable software generated by AI and stored on Monad.</p>
                    </div>

                    <!-- Filter Tabs -->
                    <div class="flex gap-2 mb-8 border-b border-white/10 pb-4 overflow-x-auto reveal">
                        <button onclick="filterCategory('All')" class="px-4 py-1.5 text-sm rounded-full bg-white/10 text-white hover:bg-white/20 transition">All</button>
                        <button onclick="filterCategory('Game')" class="px-4 py-1.5 text-sm rounded-full text-gray-400 hover:text-white hover:bg-white/5 transition">Games</button>
                        <button onclick="filterCategory('DeFi')" class="px-4 py-1.5 text-sm rounded-full text-gray-400 hover:text-white hover:bg-white/5 transition">DeFi</button>
                        <button onclick="filterCategory('Tool')" class="px-4 py-1.5 text-sm rounded-full text-gray-400 hover:text-white hover:bg-white/5 transition">Utilities</button>
                    </div>

                    <!-- Grid -->
                    <div id="appGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Empty State -->
                        <div class="col-span-full py-20 text-center border border-dashed border-white/10 rounded-xl bg-white/5 reveal">
                            <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="lock" class="text-gray-500"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white">Access Restricted</h3>
                            <p class="text-sm text-gray-500 mt-1">Connect your wallet to view the marketplace.</p>
                        </div>
                    </div>
                </section>

                <!-- VIEW: BUILDER (LABORATORY) -->
                <section id="view-builder" class="hidden animate-fade-in h-full">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
                        
                        <!-- Form Side -->
                        <div class="lg:col-span-7 space-y-8">
                            <div>
                                <h2 class="text-4xl font-bold text-white mb-2">Spell Laboratory</h2>
                                <p class="text-gray-400">Describe functionality. Generate code. Deploy immutably.</p>
                            </div>

                            <div class="glass-card p-8 rounded-2xl space-y-6">
                                <input type="hidden" id="updateId" value="">
                                <input type="hidden" id="tempCode" value="">
                                <input type="hidden" id="tempIcon" value="">

                                <div class="grid grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="text-xs font-semibold text-gray-500 uppercase">App Name</label>
                                        <input id="buildName" type="text" class="w-full bg-surface border border-white/10 p-3 rounded-lg text-white focus:border-primary outline-none transition" placeholder="e.g. Price Tracker">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-semibold text-gray-500 uppercase">Category</label>
                                        <select id="buildCategory" class="w-full bg-surface border border-white/10 p-3 rounded-lg text-white focus:border-primary outline-none transition">
                                            <option value="Game">Game</option>
                                            <option value="DeFi">DeFi</option>
                                            <option value="Tool">Utility</option>
                                            <option value="Art">Art</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Description</label>
                                    <input id="buildDesc" type="text" class="w-full bg-surface border border-white/10 p-3 rounded-lg text-white focus:border-primary outline-none transition" placeholder="Short summary for the marketplace">
                                </div>

                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-gray-500 uppercase">System Instructions (Prompt)</label>
                                    <textarea id="buildPrompt" rows="6" class="w-full bg-surface border border-white/10 p-4 rounded-lg text-white font-mono text-sm focus:border-primary outline-none transition" placeholder="Detailed requirements for the AI..."></textarea>
                                </div>

                                <div class="grid grid-cols-2 gap-6 items-center">
                                    <div class="p-4 bg-white/5 rounded-lg border border-white/5">
                                        <span class="text-xs text-gray-500 uppercase">Deploy Fee</span>
                                        <div class="text-xl font-bold text-white mt-1">50 MON</div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-semibold text-gray-500 uppercase">Sell Price</label>
                                        <input id="buildPrice" type="number" step="0.001" class="w-full bg-surface border border-white/10 p-3 rounded-lg text-white outline-none" placeholder="0">
                                    </div>
                                </div>
                                
                                <div id="compileStatus" class="hidden p-4 rounded-lg text-sm text-center font-mono"></div>

                                <div class="pt-4 flex gap-4">
                                    <button id="genBtn" onclick="generatePreview()" class="flex-1 py-4 bg-primary hover:bg-indigo-500 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
                                        <i data-lucide="sparkles"></i> Generate Preview
                                    </button>
                                    <button id="mintBtn" onclick="mintCurrentPreview()" class="hidden flex-1 py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-bold shadow-lg transition transform hover:-translate-y-1 flex items-center justify-center gap-2">
                                        <i data-lucide="rocket"></i> Deploy On-Chain
                                    </button>
                                    <button id="updateBtn" onclick="submitUpdate()" class="hidden w-full py-4 bg-blue-600 text-white rounded-xl font-bold">Update Code</button>
                                </div>
                            </div>
                        </div>

                        <!-- Visual Side -->
                        <div class="lg:col-span-5 hidden lg:flex flex-col justify-center items-center text-center p-8 bg-gradient-to-b from-white/5 to-transparent rounded-2xl border border-white/5">
                            <div class="w-48 h-48 bg-indigo-500/20 rounded-full blur-3xl mb-8"></div>
                            <h3 class="text-2xl font-bold text-white mb-4">Write Once. Run Forever.</h3>
                            <p class="text-gray-400 leading-relaxed">
                                Your application is compressed and stored directly in the blockchain's state trie. No servers. No downtime. 100% static uptime guaranteed by the protocol.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- VIEW: PROFILE -->
                <section id="view-profile" class="hidden animate-fade-in space-y-8">
                    <div class="p-8 bg-gradient-to-r from-indigo-900/50 to-purple-900/50 rounded-2xl border border-white/10 flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-bold text-white">Your Profile</h2>
                            <p id="profileAddress" class="text-indigo-300 font-mono mt-2">0x...</p>
                        </div>
                        <div class="text-right">
                            <span class="text-sm text-gray-400 uppercase">Spells Created</span>
                            <div id="profileCount" class="text-5xl font-bold text-white">0</div>
                        </div>
                    </div>
                    <div id="profileGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </section>
                
                <!-- VIEW: DOCS -->
                <section id="view-docs" class="hidden animate-fade-in max-w-4xl mx-auto">
                    <div class="mb-16 text-center">
                        <h2 class="text-5xl font-bold mb-6 text-gradient typing-target" data-text="The Grimoire"></h2>
                        <p class="text-xl text-gray-400">Technical documentation for Protocol V4</p>
                    </div>

                    <div class="space-y-12">
                        <div class="reveal">
                            <h3 class="text-2xl font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="database" class="text-primary"></i> SSTORE2 Storage</h3>
                            <p class="text-gray-400 leading-relaxed text-lg">
                                Spells V4 utilizes the <code>SSTORE2</code> pattern to store compressed bytecode directly on-chain. This ensures that the application logic is not dependent on IPFS or centralized servers. It is strictly immutable.
                            </p>
                        </div>
                        <div class="reveal">
                            <h3 class="text-2xl font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="code" class="text-primary"></i> Runtime Injection</h3>
                            <p class="text-gray-400 leading-relaxed text-lg">
                                When a user launches a Spell, the protocol fetches the bytecode, decompresses it using LZ-String, and injects a Web3 provider bridge into a sandboxed iframe. This gives the generated app safe access to the user's wallet.
                            </p>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="walletModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="bg-surface border border-white/10 p-8 rounded-2xl w-96 shadow-2xl transform transition-all scale-95 opacity-0 pop-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Connect Wallet</h3>
                <button onclick="closeWalletSelect()" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <button onclick="selectWallet('metamask')" class="w-full bg-white/5 hover:bg-white/10 p-4 rounded-xl flex items-center justify-between mb-3 transition">
                <span>MetaMask</span>
                <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
            </button>
            <button onclick="selectWallet('phantom')" class="w-full bg-white/5 hover:bg-white/10 p-4 rounded-xl flex items-center justify-between transition">
                <span>Phantom</span>
                <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
            </button>
        </div>
    </div>
    
    <div id="successModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md hidden">
        <div class="text-center">
            <div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="check" class="w-10 h-10 text-emerald-500"></i>
            </div>
            <h2 class="text-4xl font-bold text-white mb-2">Success</h2>
            <p id="successMessage" class="text-gray-400 mb-8">Transaction confirmed on-chain.</p>
            <button onclick="closeSuccessModal()" class="px-8 py-3 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition">Continue</button>
        </div>
    </div>

    <!-- APP WINDOW -->
    <div id="appWindow" class="fixed inset-0 z-[100] bg-[#09090b] hidden flex flex-col">
        <div class="h-14 border-b border-white/10 flex justify-between items-center px-6 bg-surface">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                <span id="appWindowTitle" class="font-mono text-sm text-gray-300">App Runtime</span>
            </div>
            <button onclick="closeAppWindow()" class="text-xs bg-red-500/10 text-red-400 px-3 py-1.5 rounded hover:bg-red-500/20 transition">Close Process</button>
        </div>
        <div class="flex-1 relative">
            <div id="appLoading" class="absolute inset-0 flex flex-col items-center justify-center bg-surface">
                <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                <span class="text-sm text-gray-500 font-mono">Decompressing Bytecode...</span>
            </div>
            <iframe id="appFrame" class="w-full h-full border-none bg-white"></iframe>
        </div>
    </div>

    <!-- LOGIC SCRIPTS -->
    <script>
        // --- 1. VISUAL EFFECTS ENGINE ---
        
        // Typewriter Effect
        function typeWriter(element, text, speed = 50) {
            let i = 0;
            element.innerHTML = "";
            element.classList.add('typing-cursor');
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    element.classList.remove('typing-cursor');
                }
            }
            type();
        }

        // Scroll Reveal Observer
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    entry.target.classList.add('active');
                    if(entry.target.classList.contains('typing-target')) {
                        typeWriter(entry.target, entry.target.getAttribute('data-text'));
                        entry.target.classList.remove('typing-target'); // Run once
                    }
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.reveal, .typing-target').forEach(el => observer.observe(el));

        // Background Particles
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, particles = [];

        function initBg() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            particles = [];
            for(let i=0; i<50; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    size: Math.random() * 2,
                    speed: Math.random() * 0.5 + 0.1
                });
            }
        }
        window.addEventListener('resize', initBg);
        initBg();

        function animateBg() {
            ctx.clearRect(0,0,width,height);
            ctx.fillStyle = "#6366f1"; // Indigo particles
            particles.forEach(p => {
                p.y -= p.speed;
                if(p.y < 0) p.y = height;
                ctx.globalAlpha = Math.random() * 0.5 + 0.1;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
            });
            requestAnimationFrame(animateBg);
        }
        animateBg();


        // --- 2. CORE LOGIC (UNCHANGED FUNCTIONALITY) ---
        // Keeps your existing Web3/App logic intact
        
        lucide.createIcons();
        const CONTRACT_ADDRESS = "0x53830d0F28182e0EB8F1C563AC67C6eDD0cD301b"; 
        const ABI = ["function appCount() view returns (uint256)", "function createApp(string, string, string, string, uint256) public payable", "function updateApp(uint256, string) public", "function buyApp(uint256) public payable", "function getAppInfo(uint256) view returns (string, uint256, address, string, string, uint256)", "function hasAccess(uint256, address) view returns (bool)", "function getCode(uint256) view returns (string)"];
        let provider, signer, contract, userAddress, currentFilter='All';

        function switchTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            if(document.getElementById(`nav-${id}`)) document.getElementById(`nav-${id}`).classList.add('active');
            if(id === 'marketplace') loadMarketplace();
            
            // Re-trigger animations
            document.querySelectorAll(`#view-${id} .reveal`).forEach(el => {
                el.classList.remove('active');
                setTimeout(() => el.classList.add('active'), 100);
            });
        }

        function filterCategory(cat) {
            currentFilter = cat;
            loadMarketplace();
        }

        function filterApps() {
            const q = document.getElementById("searchBar").value.toLowerCase();
            document.querySelectorAll(".spell-card").forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(q) ? "flex" : "none";
            });
        }

        // Wallet
        function openWalletSelect() { 
            const m = document.getElementById("walletModal");
            m.classList.remove("hidden");
            setTimeout(() => m.firstElementChild.classList.remove('scale-95', 'opacity-0'), 10);
        }
        function closeWalletSelect() { document.getElementById("walletModal").classList.add("hidden"); }

        async function selectWallet(type) {
            closeWalletSelect();
            let p = type === 'metamask' ? window.ethereum : window.phantom?.ethereum;
            if(!p) return alert("Wallet not installed");
            try {
                provider = new ethers.providers.Web3Provider(p);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                document.getElementById("connectBtn").innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full"></span> ${userAddress.slice(0,6)}...`;
                document.getElementById("networkStatus").innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Connected`;
                
                loadMarketplace();
            } catch(e) { console.error(e); }
        }

        async function openMyProfile() {
            if(!contract) return openWalletSelect();
            switchTab('profile');
            document.getElementById("profileAddress").innerText = userAddress;
            const grid = document.getElementById("profileGrid");
            grid.innerHTML = `<div class="col-span-full text-center py-20"><div class="w-8 h-8 border-2 border-indigo-500 rounded-full animate-spin mx-auto"></div></div>`;
            
            try {
                const count = await contract.appCount();
                let html = "", userCount = 0;
                for(let i=1; i<=count; i++) {
                    const info = await contract.getAppInfo(i);
                    if(info[2].toLowerCase() === userAddress.toLowerCase()) {
                        userCount++;
                        html += generateCardHtml(i, info, true);
                    }
                }
                document.getElementById("profileCount").innerText = userCount;
                grid.innerHTML = html || `<div class="col-span-full text-center text-gray-500">No active deployments.</div>`;
                lucide.createIcons();
            } catch(e) { console.error(e); }
        }

        async function loadMarketplace() {
            const grid = document.getElementById("appGrid");
            if(!contract) return;
            grid.innerHTML = `<div class="col-span-full text-center py-20 text-gray-500">Syncing with Monad...</div>`;
            
            try {
                const count = await contract.appCount();
                let html = "";
                for(let i=1; i<=count; i++) {
                    const info = await contract.getAppInfo(i);
                    if(currentFilter !== 'All' && info[4] !== currentFilter) continue;
                    const isOwned = await contract.hasAccess(i, userAddress);
                    html += generateCardHtml(i, info, isOwned);
                }
                grid.innerHTML = html || `<div class="col-span-full text-center py-20 text-gray-500">Marketplace empty.</div>`;
                lucide.createIcons();
                
                // Animate Cards
                document.querySelectorAll('.spell-card').forEach((c, index) => {
                    c.style.animationDelay = `${index * 50}ms`;
                    c.classList.add('reveal', 'active');
                });

            } catch(e) { grid.innerHTML = `<div class="text-red-500 text-center col-span-full">${e.message}</div>`; }
        }

        function generateCardHtml(id, info, isOwned) {
            const isCreator = (info[2].toLowerCase() === userAddress.toLowerCase());
            const price = ethers.utils.formatEther(info[1]);
            let iconSvg = '<div class="text-2xl">⚡</div>';
            try { if(info[3]) iconSvg = LZString.decompressFromBase64(info[3]) || iconSvg; } catch(e){}

            return `
            <div class="spell-card glass-card p-5 rounded-xl flex flex-col justify-between group">
                <div>
                    <div class="h-32 bg-black/40 rounded-lg mb-4 flex items-center justify-center overflow-hidden border border-white/5 group-hover:border-primary/30 transition">
                        ${iconSvg}
                    </div>
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-white truncate">${info[0]}</h3>
                        <span class="text-xs bg-white/5 px-2 py-1 rounded text-gray-400">${info[4]||'App'}</span>
                    </div>
                    <p class="text-xs text-gray-500 font-mono mb-4">By: ${info[2].slice(0,6)}...</p>
                </div>
                <div class="flex gap-2 mt-2">
                    ${isOwned 
                        ? `<button onclick="launchApp(${id}, '${info[0]}')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg font-bold text-sm transition">Launch</button>` 
                        : `<button onclick="buyApp(${id}, '${price}')" class="flex-1 bg-white hover:bg-gray-200 text-black py-2 rounded-lg font-bold text-sm transition flex justify-between px-3"><span>Buy</span> <span>${price} MON</span></button>`
                    }
                     ${isCreator ? `<button onclick="editApp(${id}, '${info[0]}')" class="p-2 bg-white/5 hover:bg-white/10 rounded-lg text-gray-400"><i data-lucide="edit-2" class="w-4 h-4"></i></button>` : ''}
                </div>
            </div>`;
        }

        // --- GENERATOR LOGIC ---
        async function generatePreview() {
            const name = document.getElementById("buildName").value;
            const desc = document.getElementById("buildDesc").value;
            const prompt = document.getElementById("buildPrompt").value;
            if(!name || !prompt) return alert("Please fill details.");

            const status = document.getElementById("compileStatus");
            status.classList.remove("hidden");
            status.innerHTML = `<span class="animate-pulse text-indigo-400">AI Architect is designing...</span>`;
            status.className = "p-4 bg-indigo-500/10 border border-indigo-500/20 rounded-lg text-center font-mono text-sm";
            
            try {
                const res = await fetch("/api/chat", {
                    method: "POST", 
                    headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ prompt: `App: ${name}. Desc: ${desc}. Requirements: ${prompt}`, message: "Generate V3 JSON" })
                });
                const data = await res.json();
                if(!data.reply || !data.reply.code) throw new Error("Generation failed.");
                
                document.getElementById("tempCode").value = LZString.compressToBase64(data.reply.code);
                document.getElementById("tempIcon").value = LZString.compressToBase64(data.reply.icon || "");
                
                runApp(data.reply.code, `Preview: ${name}`);
                
                document.getElementById("mintBtn").classList.remove("hidden");
                document.getElementById("genBtn").classList.add("hidden");
                status.innerHTML = `<span class="text-emerald-400">Preview Ready. Deploy when ready.</span>`;
                status.className = "p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-center font-mono text-sm";

            } catch(e) { 
                status.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
                status.className = "p-4 bg-red-500/10 border border-red-500/20 rounded-lg text-center font-mono text-sm";
            }
        }

        async function mintCurrentPreview() {
            if(!contract) return openWalletSelect();
            const name = document.getElementById("buildName").value;
            const price = document.getElementById("buildPrice").value;
            const cat = document.getElementById("buildCategory").value;
            const code = document.getElementById("tempCode").value;
            const icon = document.getElementById("tempIcon").value;

            try {
                const tx = await contract.createApp(name, code, icon, cat, ethers.utils.parseEther(price), { value: ethers.utils.parseEther("50") });
                await tx.wait();
                document.getElementById("successModal").classList.remove("hidden");
            } catch(e) { alert(e.message); }
        }

        // --- APP RUNNER ---
        function runApp(code, title) {
            const win = document.getElementById("appWindow");
            win.classList.remove("hidden");
            document.getElementById("appWindowTitle").innerText = title;
            document.getElementById("appLoading").classList.remove("hidden");
            
            // Bridge Logic
            const bridge = `
            <style>
                 ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
                 #platform-start { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; align-items: center; justify-content: center; color: #0f0; font-family: monospace; cursor: pointer; }
            </style>
            <div id="platform-start" onclick="this.remove(); window.focus()">[ CLICK TO INITIALIZE RUNTIME ]</div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"><\/script>
            <script>
                try { window.ethereum = window.parent.ethereum; window.ethers = window.parent.ethers; } catch(e){}
            <\/script>`;
            
            document.getElementById("appFrame").srcdoc = bridge + code;
            setTimeout(() => document.getElementById("appLoading").classList.add("hidden"), 500);
        }

        async function launchApp(id, name) {
            try {
                runApp("", name); // Open Window
                const cCode = await contract.getCode(id);
                const code = LZString.decompressFromBase64(cCode);
                runApp(code, name);
            } catch(e) { alert(e.message); closeAppWindow(); }
        }

        function closeAppWindow() {
            document.getElementById("appWindow").classList.add("hidden");
            document.getElementById("appFrame").srcdoc = "";
        }
        function closeSuccessModal() {
            document.getElementById("successModal").classList.add("hidden");
            switchTab('marketplace');
        }
        function buyApp(id, price) {
            contract.buyApp(id, { value: ethers.utils.parseEther(price) }).then(tx => tx.wait()).then(() => loadMarketplace());
        }
        function submitUpdate() { /* Existing logic... */ }
        function editApp(id, name) { switchTab('builder'); document.getElementById("buildName").value = name; /* Setup update... */ }

    </script>
</body>
</html>
