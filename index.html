<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spells Protocol | AI App Engine</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✨</text></svg>">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Modern Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        // Force Dark Mode Config
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }

        /* Animations */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 6s ease-in-out infinite; }
        
        .glass-panel {
            background: rgba(24, 24, 27, 0.4);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Typewriter Cursor */
        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-start infinite;
            color: #6366f1;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<!-- FORCED DARK BACKGROUND HERE -->
<body class="bg-[#09090b] text-zinc-200 font-sans h-screen overflow-hidden selection:bg-indigo-500/30">

    <!-- Background Effects -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] rounded-full bg-indigo-500/5 blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] rounded-full bg-purple-500/5 blur-[120px]"></div>
        <canvas id="bgCanvas" class="opacity-30"></canvas>
    </div>

    <!-- App Layout -->
    <div class="relative z-10 flex w-full h-full">
        
        <!-- SIDEBAR -->
        <aside class="hidden md:flex w-72 flex-col justify-between border-r border-white/5 bg-[#09090b]/50 backdrop-blur-xl">
            <div class="p-6">
                <!-- Brand -->
                <div class="flex items-center gap-3 mb-8 px-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                        <span class="text-white font-bold text-lg">S</span>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-tight">SPELLS</h1>
                        <p class="text-[10px] text-zinc-500 font-mono tracking-widest uppercase">Protocol V4</p>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="space-y-1">
                    <button onclick="switchTab('marketplace')" id="nav-marketplace" class="w-full flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-white bg-white/5 rounded-lg border border-white/5 transition-all group">
                        <i data-lucide="layout-grid" class="w-4 h-4 text-indigo-400"></i> Marketplace
                    </button>
                    <button onclick="switchTab('builder')" id="nav-builder" class="w-full flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-zinc-400 hover:text-white hover:bg-white/5 rounded-lg transition-all group">
                        <i data-lucide="sparkles" class="w-4 h-4 group-hover:text-indigo-400 transition-colors"></i> AI Laboratory
                    </button>
                    <button onclick="openMyProfile()" id="nav-profile" class="w-full flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-zinc-400 hover:text-white hover:bg-white/5 rounded-lg transition-all group">
                        <i data-lucide="user" class="w-4 h-4 group-hover:text-indigo-400 transition-colors"></i> Profile
                    </button>
                    <button onclick="switchTab('docs')" id="nav-docs" class="w-full flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-zinc-400 hover:text-white hover:bg-white/5 rounded-lg transition-all group">
                        <i data-lucide="book" class="w-4 h-4 group-hover:text-indigo-400 transition-colors"></i> Documentation
                    </button>
                </nav>
            </div>

            <!-- Connect -->
            <div class="p-6 border-t border-white/5">
                <button id="connectBtn" onclick="openWalletSelect()" class="w-full py-2.5 bg-white hover:bg-zinc-200 text-black text-sm font-semibold rounded-lg transition-all shadow-lg shadow-white/5 flex items-center justify-center gap-2">
                    Connect Wallet
                </button>
                <div class="mt-4 flex items-center justify-center gap-2 text-xs text-zinc-500 font-mono">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                    Operational
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto relative scroll-smooth">
            <div class="max-w-6xl mx-auto p-8 md:p-12 pb-32">
                
                <!-- Header / Search -->
                <div class="flex justify-between items-center mb-12 animate-float">
                    <div class="relative w-full max-w-md">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 w-4 h-4"></i>
                        <input id="searchBar" onkeyup="filterApps()" type="text" placeholder="Search applications..." 
                               class="w-full bg-[#18181b] border border-zinc-800 text-sm text-white rounded-full pl-10 pr-4 py-3 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all placeholder-zinc-600">
                    </div>
                </div>

                <!-- VIEW: MARKETPLACE -->
                <section id="view-marketplace" class="space-y-8">
                    <div class="space-y-4">
                        <h2 class="text-4xl md:text-5xl font-bold text-white typing-target" data-text="Intelligent Software."></h2>
                        <p class="text-lg text-zinc-400 max-w-2xl">
                            Decentralized applications generated by AI, compiled to bytecode, and stored permanently on the Monad blockchain.
                        </p>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 border-b border-white/5 pb-4 overflow-x-auto">
                        <button onclick="filterCategory('All')" class="px-4 py-1.5 text-sm font-medium rounded-full bg-indigo-500/10 text-indigo-400 border border-indigo-500/20">All</button>
                        <button onclick="filterCategory('Game')" class="px-4 py-1.5 text-sm font-medium rounded-full text-zinc-400 hover:text-white hover:bg-white/5 transition-colors">Games</button>
                        <button onclick="filterCategory('DeFi')" class="px-4 py-1.5 text-sm font-medium rounded-full text-zinc-400 hover:text-white hover:bg-white/5 transition-colors">DeFi</button>
                        <button onclick="filterCategory('Tool')" class="px-4 py-1.5 text-sm font-medium rounded-full text-zinc-400 hover:text-white hover:bg-white/5 transition-colors">Utilities</button>
                    </div>

                    <!-- Grid -->
                    <div id="appGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Default Empty State -->
                        <div class="col-span-full py-24 text-center border border-dashed border-zinc-800 rounded-2xl bg-zinc-900/30">
                            <div class="w-16 h-16 bg-zinc-900 rounded-full flex items-center justify-center mx-auto mb-4 border border-zinc-800">
                                <i data-lucide="lock" class="text-zinc-500 w-6 h-6"></i>
                            </div>
                            <h3 class="text-lg font-medium text-white">Marketplace Locked</h3>
                            <p class="text-sm text-zinc-500 mt-2">Connect your wallet to decrypt the registry.</p>
                        </div>
                    </div>
                </section>

                <!-- VIEW: BUILDER -->
                <section id="view-builder" class="hidden h-full">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
                        <div class="lg:col-span-7 space-y-6">
                            <div>
                                <h2 class="text-3xl font-bold text-white">AI Laboratory</h2>
                                <p class="text-zinc-400">Describe your application. The Protocol handles the rest.</p>
                            </div>

                            <div class="bg-[#18181b] border border-zinc-800 p-8 rounded-2xl space-y-6 shadow-2xl">
                                <input type="hidden" id="updateId" value="">
                                <input type="hidden" id="tempCode" value="">
                                <input type="hidden" id="tempIcon" value="">

                                <div class="grid grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Name</label>
                                        <input id="buildName" type="text" class="w-full bg-black/50 border border-zinc-800 p-3 rounded-lg text-white focus:border-indigo-500 outline-none transition" placeholder="e.g. Flappy Bird Clone">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Category</label>
                                        <select id="buildCategory" class="w-full bg-black/50 border border-zinc-800 p-3 rounded-lg text-white focus:border-indigo-500 outline-none transition">
                                            <option value="Game">Game</option>
                                            <option value="DeFi">DeFi</option>
                                            <option value="Tool">Utility</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Description</label>
                                    <input id="buildDesc" type="text" class="w-full bg-black/50 border border-zinc-800 p-3 rounded-lg text-white focus:border-indigo-500 outline-none transition" placeholder="Brief summary">
                                </div>

                                <div class="space-y-2">
                                    <label class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">System Prompt</label>
                                    <textarea id="buildPrompt" rows="5" class="w-full bg-black/50 border border-zinc-800 p-4 rounded-lg text-white font-mono text-sm focus:border-indigo-500 outline-none transition" placeholder="Detailed requirements..."></textarea>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-indigo-500/5 border border-indigo-500/10 rounded-lg">
                                    <div class="text-xs text-indigo-400 font-mono">ESTIMATED COST</div>
                                    <div class="text-xl font-bold text-white">50 MON</div>
                                </div>

                                <div class="grid grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Sell Price (MON)</label>
                                        <input id="buildPrice" type="number" step="0.001" class="w-full bg-black/50 border border-zinc-800 p-3 rounded-lg text-white outline-none" placeholder="0">
                                    </div>
                                </div>
                                
                                <div id="compileStatus" class="hidden p-4 rounded-lg text-sm text-center font-mono"></div>

                                <div class="flex gap-4 pt-2">
                                    <button id="genBtn" onclick="generatePreview()" class="flex-1 py-3.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition flex items-center justify-center gap-2">
                                        <i data-lucide="sparkles" class="w-4 h-4"></i> Generate
                                    </button>
                                    <button id="mintBtn" onclick="mintCurrentPreview()" class="hidden flex-1 py-3.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold transition flex items-center justify-center gap-2">
                                        <i data-lucide="upload-cloud" class="w-4 h-4"></i> Deploy
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Info Side -->
                        <div class="lg:col-span-5 hidden lg:flex flex-col justify-center items-center text-center p-12 bg-zinc-900/30 border border-dashed border-zinc-800 rounded-2xl">
                            <div class="w-32 h-32 bg-indigo-500/10 rounded-full blur-2xl mb-8 animate-pulse"></div>
                            <h3 class="text-xl font-bold text-white mb-2">Immutable Infrastructure</h3>
                            <p class="text-zinc-400 text-sm leading-relaxed">
                                Generated code is compressed via LZ-String and stored in Monad's SSTORE2 pointers. It runs client-side in a sandboxed iframe with a Web3 bridge.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- VIEW: PROFILE -->
                <section id="view-profile" class="hidden space-y-8">
                    <div class="p-8 bg-zinc-900/50 border border-zinc-800 rounded-2xl flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-white">Caster Profile</h2>
                            <p id="profileAddress" class="text-zinc-500 font-mono mt-1 text-sm">0x...</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-zinc-500 uppercase tracking-wider">Total Deployments</span>
                            <div id="profileCount" class="text-4xl font-bold text-white mt-1">0</div>
                        </div>
                    </div>
                    <div id="profileGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </section>
                
                <!-- VIEW: DOCS -->
                <section id="view-docs" class="hidden max-w-3xl mx-auto space-y-12">
                    <div class="text-center mb-16">
                        <h2 class="text-4xl font-bold text-white mb-4">Documentation</h2>
                        <p class="text-zinc-400">Technical details for Spells Protocol V4.</p>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="server" class="text-indigo-500"></i> Architecture</h3>
                        <div class="p-6 bg-zinc-900/50 border border-zinc-800 rounded-xl">
                            <p class="text-zinc-400 leading-relaxed text-sm">
                                Applications are generated as single-file HTML blobs. These blobs are compressed and split into SSTORE2 pointers on the Monad blockchain. The `SpellsV4` contract acts as a registry, mapping Token IDs to these pointers.
                            </p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="shield" class="text-emerald-500"></i> Security</h3>
                        <div class="p-6 bg-zinc-900/50 border border-zinc-800 rounded-xl">
                            <p class="text-zinc-400 leading-relaxed text-sm">
                                Runtime execution happens in a sandboxed `iframe` with `allow-scripts` and `allow-same-origin`. A secure bridge injects `window.ethereum` from the parent window, allowing the immutable app to sign transactions without accessing private keys directly.
                            </p>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="walletModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden transition-all">
        <div class="bg-[#18181b] border border-zinc-800 p-6 rounded-2xl w-96 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">Connect Wallet</h3>
                <button onclick="closeWalletSelect()" class="text-zinc-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-3">
                <button onclick="selectWallet('metamask')" class="w-full bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 p-4 rounded-xl flex items-center justify-between transition group">
                    <span class="text-zinc-300 group-hover:text-white font-medium">MetaMask</span>
                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-orange-400 to-orange-600"></div>
                </button>
                <button onclick="selectWallet('phantom')" class="w-full bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 p-4 rounded-xl flex items-center justify-between transition group">
                    <span class="text-zinc-300 group-hover:text-white font-medium">Phantom</span>
                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-purple-400 to-purple-600"></div>
                </button>
            </div>
        </div>
    </div>
    
    <div id="successModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md hidden">
        <div class="text-center p-8">
            <div class="w-16 h-16 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-emerald-500/20">
                <i data-lucide="check" class="w-8 h-8 text-emerald-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Success</h2>
            <p id="successMessage" class="text-zinc-400 mb-8 max-w-xs mx-auto">Operation completed successfully on the network.</p>
            <button onclick="closeSuccessModal()" class="px-8 py-2.5 bg-white text-black font-bold rounded-lg hover:bg-zinc-200 transition">Continue</button>
        </div>
    </div>

    <!-- App Runner -->
    <div id="appWindow" class="fixed inset-0 z-[100] bg-[#09090b] hidden flex flex-col">
        <div class="h-14 border-b border-white/5 flex justify-between items-center px-6 bg-[#18181b]">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_8px_#10b981]"></div>
                <span id="appWindowTitle" class="font-mono text-sm text-zinc-400">Runtime Active</span>
            </div>
            <button onclick="closeAppWindow()" class="text-xs font-medium bg-red-500/10 text-red-400 px-3 py-1.5 rounded-full hover:bg-red-500/20 transition">Terminate</button>
        </div>
        <div class="flex-1 relative bg-black">
            <div id="appLoading" class="absolute inset-0 flex flex-col items-center justify-center bg-[#09090b] z-50">
                <div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <span class="text-xs text-zinc-500 font-mono uppercase tracking-widest">Initializing Environment...</span>
            </div>
            <iframe id="appFrame" class="w-full h-full border-none"></iframe>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // Init
        lucide.createIcons();
        const CONTRACT_ADDRESS = "0x53830d0F28182e0EB8F1C563AC67C6eDD0cD301b"; 
        const ABI = ["function appCount() view returns (uint256)", "function createApp(string, string, string, string, uint256) public payable", "function updateApp(uint256, string) public", "function buyApp(uint256) public payable", "function getAppInfo(uint256) view returns (string, uint256, address, string, string, uint256)", "function hasAccess(uint256, address) view returns (bool)", "function getCode(uint256) view returns (string)"];
        let provider, signer, contract, userAddress, currentFilter='All';

        // Particle BG
        const canvas = document.getElementById('bgCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, particles=[];
        function initBg(){ width=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; particles=[]; for(let i=0;i<40;i++) particles.push({x:Math.random()*width,y:Math.random()*height,r:Math.random()*1.5,dx:(Math.random()-0.5)*0.2,dy:(Math.random()-0.5)*0.2}); }
        function animBg(){ ctx.clearRect(0,0,width,height); ctx.fillStyle="#a1a1aa"; particles.forEach(p=>{ p.x+=p.dx; p.y+=p.dy; if(p.x<0)p.x=width; if(p.x>width)p.x=0; if(p.y<0)p.y=height; if(p.y>height)p.y=0; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }); requestAnimationFrame(animBg); }
        window.addEventListener('resize',initBg); initBg(); animBg();

        // UI Logic
        function typeWriter(el, txt) {
            let i=0; el.innerHTML=""; el.classList.add('typing-cursor');
            function type(){ if(i<txt.length){el.innerHTML+=txt.charAt(i); i++; setTimeout(type,40);} else el.classList.remove('typing-cursor'); }
            type();
        }
        document.querySelectorAll('.typing-target').forEach(el => typeWriter(el, el.getAttribute('data-text')));

        function switchTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('aside nav button').forEach(b => {
                b.classList.remove('text-white', 'bg-white/5');
                b.classList.add('text-zinc-400');
            });
            document.getElementById(`view-${id}`).classList.remove('hidden');
            const nav = document.getElementById(`nav-${id}`);
            if(nav) { nav.classList.remove('text-zinc-400'); nav.classList.add('text-white', 'bg-white/5'); }
            if(id === 'marketplace') loadMarketplace();
        }

        function filterCategory(cat) { currentFilter=cat; loadMarketplace(); }
        function filterApps() {
            const q = document.getElementById("searchBar").value.toLowerCase();
            document.querySelectorAll(".spell-card").forEach(c => c.style.display = c.innerText.toLowerCase().includes(q)?"block":"none");
        }

        // Web3
        function openWalletSelect(){ document.getElementById("walletModal").classList.remove("hidden"); }
        function closeWalletSelect(){ document.getElementById("walletModal").classList.add("hidden"); }
        async function selectWallet(type){
            closeWalletSelect();
            const p = type==='metamask'?window.ethereum:window.phantom?.ethereum;
            if(!p) return alert("Wallet not found");
            try {
                provider = new ethers.providers.Web3Provider(p);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                document.getElementById("connectBtn").innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> ${userAddress.slice(0,6)}...`;
                loadMarketplace();
            } catch(e){console.error(e);}
        }

        async function openMyProfile() {
            if(!contract) return openWalletSelect();
            switchTab('profile');
            document.getElementById("profileAddress").innerText = userAddress;
            const grid = document.getElementById("profileGrid");
            grid.innerHTML = `<div class="col-span-full text-center py-12 text-zinc-500">Fetching immutable records...</div>`;
            try {
                const count = await contract.appCount();
                let html="", userCount=0;
                for(let i=1; i<=count; i++){
                    const info = await contract.getAppInfo(i);
                    if(info[2].toLowerCase()===userAddress.toLowerCase()){
                        userCount++;
                        html += generateCardHtml(i, info, true);
                    }
                }
                document.getElementById("profileCount").innerText = userCount;
                grid.innerHTML = html || `<div class="col-span-full text-center py-12 text-zinc-600">No spells deployed yet.</div>`;
                lucide.createIcons();
            } catch(e){console.error(e);}
        }

        async function loadMarketplace() {
            const grid = document.getElementById("appGrid");
            if(!contract) return;
            grid.innerHTML = `<div class="col-span-full text-center py-12 text-zinc-500 animate-pulse">Querying Monad Blockchain...</div>`;
            try {
                const count = await contract.appCount();
                let html="";
                for(let i=1; i<=count; i++){
                    const info = await contract.getAppInfo(i);
                    if(currentFilter!=='All' && info[4]!==currentFilter) continue;
                    const isOwned = await contract.hasAccess(i, userAddress);
                    html += generateCardHtml(i, info, isOwned);
                }
                grid.innerHTML = html || `<div class="col-span-full text-center py-12 text-zinc-600">Registry is empty.</div>`;
                lucide.createIcons();
            } catch(e){ grid.innerHTML=`<div class="col-span-full text-red-500 text-center">${e.message}</div>`; }
        }

        function generateCardHtml(id, info, isOwned) {
            const isCreator = (info[2].toLowerCase() === userAddress.toLowerCase());
            const price = ethers.utils.formatEther(info[1]);
            let iconSvg = '<div class="text-3xl">⚡</div>';
            try { if(info[3]) iconSvg = LZString.decompressFromBase64(info[3]) || iconSvg; } catch(e){}

            return `
            <div class="spell-card bg-[#18181b] border border-zinc-800 hover:border-indigo-500/50 rounded-xl overflow-hidden group transition-all hover:shadow-xl hover:shadow-indigo-500/10">
                <div class="h-40 bg-zinc-900 flex items-center justify-center relative overflow-hidden">
                    <div class="scale-100 group-hover:scale-110 transition-transform duration-500">${iconSvg}</div>
                    <div class="absolute top-3 right-3 bg-black/60 backdrop-blur px-2 py-1 rounded text-[10px] text-white font-mono uppercase tracking-wider">${info[4]||'App'}</div>
                </div>
                <div class="p-5">
                    <h3 class="text-white font-bold text-lg mb-1 truncate">${info[0]}</h3>
                    <p class="text-zinc-500 text-xs font-mono mb-4">DEV: ${info[2].slice(0,6)}...</p>
                    <div class="flex gap-2">
                         ${isOwned 
                            ? `<button onclick="launchApp(${id}, '${info[0]}')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg font-medium text-sm transition-colors">Launch</button>`
                            : `<button onclick="buyApp(${id}, '${price}')" class="flex-1 bg-white hover:bg-zinc-200 text-black py-2 rounded-lg font-bold text-sm transition-colors flex justify-between px-3"><span>Acquire</span> <span>${price} M</span></button>`
                        }
                        ${isCreator ? `<button onclick="editApp(${id}, '${info[0]}')" class="px-3 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-zinc-400"><i data-lucide="edit-2" class="w-4 h-4"></i></button>` : ''}
                    </div>
                </div>
            </div>`;
        }

        // Generator
        async function generatePreview() {
            const name=document.getElementById("buildName").value;
            const desc=document.getElementById("buildDesc").value;
            const prompt=document.getElementById("buildPrompt").value;
            const status=document.getElementById("compileStatus");
            
            if(!name || !prompt) return alert("Missing requirements.");
            
            status.classList.remove("hidden");
            status.className="p-4 bg-indigo-500/10 border border-indigo-500/20 text-indigo-300 rounded-lg text-sm text-center";
            status.innerText="Initializing Neural Network...";
            
            try {
                const res = await fetch("/api/chat", {
                    method:"POST", headers:{"Content-Type":"application/json"},
                    body:JSON.stringify({prompt:`App:${name}. Desc:${desc}. Req:${prompt}`, message:"Generate V3 JSON"})
                });
                const data = await res.json();
                if(!data.reply?.code) throw new Error("Output verification failed.");
                
                document.getElementById("tempCode").value = LZString.compressToBase64(data.reply.code);
                document.getElementById("tempIcon").value = LZString.compressToBase64(data.reply.icon || "");
                runApp(data.reply.code, `Preview: ${name}`);
                
                document.getElementById("genBtn").classList.add("hidden");
                document.getElementById("mintBtn").classList.remove("hidden");
                status.className="p-4 bg-emerald-500/10 border border-emerald-500/20 text-emerald-300 rounded-lg text-sm text-center";
                status.innerText="Compilation Complete. Ready to Deploy.";
            } catch(e) {
                status.className="p-4 bg-red-500/10 border border-red-500/20 text-red-300 rounded-lg text-sm text-center";
                status.innerText=`Error: ${e.message}`;
            }
        }

        async function mintCurrentPreview() {
            if(!contract) return openWalletSelect();
            // ... (Mint logic same as before, ensures simple connection) ...
            try {
                const tx = await contract.createApp(
                    document.getElementById("buildName").value,
                    document.getElementById("tempCode").value,
                    document.getElementById("tempIcon").value,
                    document.getElementById("buildCategory").value,
                    ethers.utils.parseEther(document.getElementById("buildPrice").value),
                    { value: ethers.utils.parseEther("50") }
                );
                await tx.wait();
                document.getElementById("successModal").classList.remove("hidden");
            } catch(e) { alert(e.message); }
        }

        // Runner
        function runApp(code, title) {
            document.getElementById("appWindow").classList.remove("hidden");
            document.getElementById("appWindowTitle").innerText = title;
            document.getElementById("appLoading").classList.remove("hidden");
            
            const bridge = `
            <style>::-webkit-scrollbar{width:0px}body{margin:0;overflow:hidden}#start-ol{position:fixed;inset:0;background:#000;z-index:9999;display:flex;align-items:center;justify-content:center;color:#0f0;font-family:monospace;cursor:pointer}</style>
            <div id="start-ol" onclick="this.remove()">[ CLICK TO START ]</div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"><\/script>
            <script>window.ethereum=window.parent.ethereum;window.ethers=window.parent.ethers;<\/script>`;
            
            document.getElementById("appFrame").srcdoc = bridge + code;
            setTimeout(()=>document.getElementById("appLoading").classList.add("hidden"), 800);
        }

        function closeAppWindow(){ 
            document.getElementById("appWindow").classList.add("hidden"); 
            document.getElementById("appFrame").srcdoc=""; 
        }
        function closeSuccessModal(){ 
            document.getElementById("successModal").classList.add("hidden"); 
            switchTab('marketplace'); 
        }
        function buyApp(id, price) {
            contract.buyApp(id, {value:ethers.utils.parseEther(price)}).then(tx=>tx.wait()).then(()=>loadMarketplace());
        }
        function editApp(id, name) { switchTab('builder'); document.getElementById("buildName").value=name; }
    </script>
</body>
</html>
