<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spells Protocol V4 | AI Engine</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’ </text></svg>">

    <!-- Core -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { obsidian: '#050505', charcoal: '#0F0F12', neon: '#6366f1' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #e4e4e7; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        #neuralCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.6; }
        .glass-panel { background: rgba(15, 15, 18, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .spotlight-group:hover .spotlight { opacity: 1; }
        .spotlight { background: radial-gradient(600px circle at var(--x) var(--y), rgba(99, 102, 241, 0.15), transparent 40%); z-index: 1; }
    </style>
</head>
<body class="antialiased selection:bg-indigo-500/30">

    <canvas id="neuralCanvas"></canvas>
    
    <!-- Glow Effects -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-0 left-1/4 w-[500px] h-[500px] bg-indigo-600/10 rounded-full blur-[128px]"></div>
        <div class="absolute bottom-0 right-1/4 w-[600px] h-[600px] bg-purple-600/5 rounded-full blur-[128px]"></div>
    </div>

    <div class="relative z-10 flex h-screen overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="w-20 lg:w-72 flex-shrink-0 flex flex-col justify-between border-r border-white/5 bg-charcoal/50 backdrop-blur-xl z-50">
            <div>
                <div class="h-20 flex items-center justify-center lg:justify-start lg:px-8 border-b border-white/5">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                        <i data-lucide="cpu" class="text-white w-6 h-6"></i>
                    </div>
                    <div class="hidden lg:block ml-4">
                        <h1 class="font-bold text-white text-lg">SPELLS</h1>
                        <p class="text-[10px] text-gray-500 font-mono tracking-widest uppercase">Protocol V4</p>
                    </div>
                </div>
                <nav class="mt-8 space-y-2 px-2 lg:px-4">
                    <button onclick="switchTab('home')" id="nav-home" class="nav-btn active w-full flex items-center gap-4 px-3 lg:px-4 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                        <i data-lucide="home" class="w-5 h-5"></i><span class="hidden lg:block">Overview</span>
                    </button>
                    <button onclick="switchTab('marketplace')" id="nav-marketplace" class="nav-btn w-full flex items-center gap-4 px-3 lg:px-4 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                        <i data-lucide="grid" class="w-5 h-5"></i><span class="hidden lg:block">Marketplace</span>
                    </button>
                    <button onclick="switchTab('builder')" id="nav-builder" class="nav-btn w-full flex items-center gap-4 px-3 lg:px-4 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                        <i data-lucide="sparkles" class="w-5 h-5"></i><span class="hidden lg:block">Laboratory</span>
                    </button>
                    <button onclick="switchTab('docs')" id="nav-docs" class="nav-btn w-full flex items-center gap-4 px-3 lg:px-4 py-3 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-all group">
                        <i data-lucide="book-open" class="w-5 h-5"></i><span class="hidden lg:block">Documentation</span>
                    </button>
                </nav>
            </div>
            <div class="p-4 border-t border-white/5">
                <button id="connectBtn" onclick="openWalletSelect()" class="w-full py-3 bg-white text-black hover:bg-gray-200 rounded-xl font-bold text-sm transition shadow-lg flex items-center justify-center gap-2">
                    <i data-lucide="wallet" class="w-4 h-4"></i><span class="hidden lg:inline">Connect</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main id="mainContainer" class="flex-1 overflow-y-auto scroll-smooth relative" onmousemove="handleSpotlight(event)">
            
            <!-- VIEW: HOME -->
            <section id="view-home" class="min-h-full">
                <div class="relative pt-32 pb-20 px-8 md:px-16 max-w-7xl mx-auto">
                    <h1 class="text-5xl md:text-7xl font-bold text-white mb-6 leading-tight">
                        The Infinite <br> <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">App Engine.</span>
                    </h1>
                    <p class="text-xl text-gray-400 max-w-2xl mb-10 leading-relaxed">
                        Generate, deploy, and trade full-stack applications entirely on-chain. No servers. No IPFS. Just pure bytecode.
                    </p>
                    <div class="flex gap-4">
                        <button onclick="switchTab('marketplace')" class="px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition shadow-lg flex items-center gap-2">Explore Apps <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </section>

            <!-- VIEW: MARKETPLACE -->
            <section id="view-marketplace" class="hidden min-h-full p-8 md:p-16">
                <div class="max-w-7xl mx-auto">
                    <div class="flex justify-between items-end mb-8">
                        <h2 class="text-4xl font-bold text-white">Registry</h2>
                        <div class="flex gap-2">
                            <button onclick="filterCategory('All')" class="px-4 py-2 text-xs font-bold rounded-lg bg-white text-black">ALL</button>
                            <button onclick="filterCategory('Game')" class="px-4 py-2 text-xs font-bold rounded-lg bg-white/5 text-gray-400 hover:text-white">GAMES</button>
                        </div>
                    </div>
                    <div id="appGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="col-span-full py-20 text-center border border-dashed border-white/10 rounded-2xl">
                            <p class="text-gray-500">Connecting to Blockchain Node...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: BUILDER -->
            <section id="view-builder" class="hidden min-h-full p-8 md:p-12">
                <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <div class="glass-panel p-8 rounded-2xl h-fit">
                        <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="terminal" class="text-indigo-400"></i> Construction Kit</h2>
                        <div class="space-y-6">
                            <input type="hidden" id="tempCode"><input type="hidden" id="tempIcon">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Application Name</label>
                                <input id="buildName" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg text-white focus:border-indigo-500 outline-none" placeholder="e.g. Tetris Clone">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">System Prompt</label>
                                <textarea id="buildPrompt" rows="6" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg text-white font-mono text-sm focus:border-indigo-500 outline-none" placeholder="Describe functionality..."></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Category</label>
                                    <select id="buildCategory" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg text-white outline-none">
                                        <option value="Game">Game</option>
                                        <option value="DeFi">DeFi</option>
                                        <option value="Tool">Utility</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Price (MON)</label>
                                    <input id="buildPrice" type="number" class="w-full bg-black/40 border border-white/10 p-3 rounded-lg text-white outline-none" placeholder="0.00">
                                </div>
                            </div>
                            <div id="compileStatus" class="hidden p-4 rounded-lg font-mono text-xs"></div>
                            <div class="flex gap-4 pt-4">
                                <button id="genBtn" onclick="generatePreview()" class="flex-1 py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition">Generate v1.0</button>
                                <button id="mintBtn" onclick="mintCurrentPreview()" class="hidden flex-1 py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold transition">Deploy on Monad</button>
                            </div>
                        </div>
                    </div>
                    <!-- Terminal -->
                    <div class="p-6 bg-black border border-white/10 rounded-2xl font-mono text-xs text-gray-500 h-64 overflow-hidden relative">
                        <p>> Initializing Builder Environment...</p>
                        <p>> Ready for input_</p>
                    </div>
                </div>
            </section>

            <!-- VIEW: DOCS -->
            <section id="view-docs" class="hidden min-h-full p-8 md:p-16 max-w-6xl mx-auto">
                <h1 class="text-5xl font-bold text-white mb-8">Documentation</h1>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-12">
                    <div class="space-y-2 sticky top-8 h-fit">
                        <button onclick="scrollToDoc('doc-intro')" class="block text-gray-400 hover:text-white transition">Introduction</button>
                        <button onclick="scrollToDoc('doc-arch')" class="block text-gray-400 hover:text-white transition">Architecture</button>
                    </div>
                    <div class="lg:col-span-3 space-y-16">
                        <div id="doc-intro">
                            <h3 class="text-2xl font-bold text-white mb-4">Introduction</h3>
                            <p class="text-gray-400">Spells Protocol stores full HTML5 applications on the Monad Blockchain using SSTORE2.</p>
                        </div>
                        <div id="doc-arch">
                            <h3 class="text-2xl font-bold text-white mb-4">Architecture</h3>
                            <p class="text-gray-400">The `SpellsProtocolV4` contract maps Token IDs to data pointers. `getCode(id)` retrieves the compressed string.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- APP RUNNER -->
    <div id="appWindow" class="fixed inset-0 z-[100] bg-[#050505] hidden flex flex-col">
        <div class="h-14 border-b border-white/5 bg-[#0F0F12] flex justify-between items-center px-6">
            <span class="text-sm font-mono text-gray-400 uppercase">Runtime Environment</span>
            <button onclick="closeAppWindow()" class="text-xs bg-red-500/10 text-red-400 px-4 py-2 rounded-lg hover:bg-red-500/20">Terminate</button>
        </div>
        <div class="flex-1 relative"><iframe id="appFrame" class="w-full h-full border-none bg-white"></iframe></div>
    </div>

    <!-- WALLET MODAL -->
    <div id="walletModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-panel p-8 rounded-2xl w-96 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-6">Connect Wallet</h3>
            <button onclick="selectWallet('metamask')" class="w-full bg-white/5 border border-white/5 p-4 rounded-xl flex justify-between mb-3 hover:bg-white/10 text-white">MetaMask</button>
            <button onclick="closeWalletSelect()" class="text-gray-500 hover:text-white w-full text-center text-sm mt-4">Cancel</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // âš ï¸ PASTE YOUR ADDRESS BELOW OR IT WON'T WORK âš ï¸
        const CONTRACT_ADDRESS = "0x53830d0F28182e0EB8F1C563AC67C6eDD0cD301b"; 
        
        const ABI = [
            "function appCount() view returns (uint256)",
            "function createApp(string, string, string, string, uint256) public payable",
            "function buyApp(uint256) public payable",
            "function getAppInfo(uint256) view returns (string, uint256, address, string, string, uint256)",
            "function hasAccess(uint256, address) view returns (bool)",
            "function getCode(uint256) view returns (string)"
        ];

        lucide.createIcons();
        let provider, signer, contract, userAddress, currentFilter='All';

        // --- BACKGROUND ---
        const canvas = document.getElementById('neuralCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, nodes = [];
        const mouse = { x: null, y: null, radius: 150 };
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; initNodes(); }
        window.addEventListener('resize', resize);
        window.addEventListener('mousemove', (e) => { mouse.x = e.x; mouse.y = e.y; });
        function initNodes() { nodes = []; for(let i=0; i<50; i++) nodes.push({ x: Math.random()*width, y: Math.random()*height, vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5 }); }
        function animateNodes() {
            ctx.clearRect(0,0,width,height); ctx.fillStyle='#6366f1'; ctx.strokeStyle='#6366f1';
            nodes.forEach(n => {
                n.x+=n.vx; n.y+=n.vy; if(n.x<0||n.x>width)n.vx*=-1; if(n.y<0||n.y>height)n.vy*=-1;
                ctx.globalAlpha=0.5; ctx.beginPath(); ctx.arc(n.x,n.y,2,0,Math.PI*2); ctx.fill();
                nodes.forEach(o => {
                    const d = Math.hypot(n.x-o.x, n.y-o.y);
                    if(d<100) { ctx.globalAlpha=(1-d/100)*0.2; ctx.beginPath(); ctx.moveTo(n.x,n.y); ctx.lineTo(o.x,o.y); ctx.stroke(); }
                });
            });
            requestAnimationFrame(animateNodes);
        }
        initNodes(); animateNodes();

        // --- UI & TABS ---
        function handleSpotlight(e) {
            document.querySelectorAll('.spotlight').forEach(el => {
                const rect = el.parentElement.getBoundingClientRect();
                el.style.setProperty('--x', (e.clientX - rect.left) + 'px');
                el.style.setProperty('--y', (e.clientY - rect.top) + 'px');
            });
        }
        function switchTab(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-white', 'bg-white/5'));
            document.getElementById(`nav-${id}`).classList.add('text-white', 'bg-white/5');
            if(id==='marketplace') loadMarketplace();
        }
        function scrollToDoc(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }

        // --- WEB3 ---
        function openWalletSelect() { document.getElementById('walletModal').classList.remove('hidden'); }
        function closeWalletSelect() { document.getElementById('walletModal').classList.add('hidden'); }
        async function selectWallet(type) {
            closeWalletSelect();
            if(!window.ethereum) return alert("Wallet not found");
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            document.getElementById('connectBtn').innerHTML = `${userAddress.slice(0,6)}...`;
            loadMarketplace();
        }

        async function loadMarketplace() {
            const grid = document.getElementById('appGrid');
            if(!contract) return;
            grid.innerHTML = `<div class="col-span-full text-center py-20 text-indigo-400">Loading...</div>`;
            try {
                const count = await contract.appCount();
                let html = "";
                for(let i=1; i<=count; i++) {
                    const info = await contract.getAppInfo(i);
                    const isOwned = await contract.hasAccess(i, userAddress);
                    const isCreator = info[2].toLowerCase() === userAddress.toLowerCase();
                    if(currentFilter !== 'All' && info[4] !== currentFilter) continue;
                    
                    let icon = 'ðŸ’ ';
                    try { if(info[3]) icon = LZString.decompressFromBase64(info[3]) || icon; } catch(e){}

                    html += `
                    <div class="glass-panel p-5 rounded-2xl spotlight-group relative hover:-translate-y-1 transition">
                        <div class="spotlight absolute -inset-px opacity-0 transition-opacity duration-300 rounded-2xl"></div>
                        <div class="relative z-10">
                            <div class="h-40 bg-black/40 rounded-xl mb-4 flex items-center justify-center overflow-hidden border border-white/5">${icon}</div>
                            <h3 class="font-bold text-white truncate">${info[0]}</h3>
                            <div class="flex gap-2 mt-4">
                                ${isOwned || isCreator
                                    ? `<button onclick="launchApp(${i}, '${info[0]}', true)" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg font-bold text-xs">Launch</button>`
                                    : `<button onclick="buyApp(${i}, '${ethers.utils.formatEther(info[1])}')" class="flex-1 bg-white hover:bg-gray-200 text-black py-2 rounded-lg font-bold text-xs">Buy ${ethers.utils.formatEther(info[1])} M</button>`
                                }
                            </div>
                        </div>
                    </div>`;
                }
                grid.innerHTML = html || `<div class="col-span-full text-center text-gray-500">No Apps Found</div>`;
                lucide.createIcons();
            } catch(e) { grid.innerHTML = `<div class="col-span-full text-red-500 text-center">${e.message}</div>`; }
        }

        async function generatePreview() {
            const name = document.getElementById('buildName').value;
            const prompt = document.getElementById('buildPrompt').value;
            const status = document.getElementById('compileStatus');
            
            if(!name || !prompt) return alert("Fill all fields");
            status.classList.remove('hidden');
            status.innerHTML = `<span class="animate-pulse text-indigo-400">Generating...</span>`;
            status.className = "p-4 bg-indigo-900/20 rounded-lg font-mono text-xs text-indigo-300";

            try {
                const res = await fetch("/api/chat", {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ prompt: `App:${name}. Req:${prompt}`, message: "Generate Code" })
                });
                const data = await res.json();
                
                if(data.error) throw new Error(data.details || data.error);
                if(!data.reply?.code) throw new Error("No code returned");

                document.getElementById("tempCode").value = LZString.compressToBase64(data.reply.code);
                document.getElementById("tempIcon").value = LZString.compressToBase64(data.reply.icon || "");

                // Launch Local Preview
                launchApp(null, `PREVIEW: ${name}`, false, data.reply.code);
                
                document.getElementById("genBtn").classList.add("hidden");
                document.getElementById("mintBtn").classList.remove("hidden");
                status.innerHTML = `<span class="text-emerald-400">Success. Ready to Deploy.</span>`;
            } catch(e) {
                status.innerHTML = `<span class="text-red-400">Error: ${e.message}</span>`;
            }
        }

        async function mintCurrentPreview() {
            if(!contract) return openWalletSelect();
            try {
                const tx = await contract.createApp(
                    document.getElementById("buildName").value,
                    document.getElementById("tempCode").value,
                    document.getElementById("tempIcon").value,
                    document.getElementById("buildCategory").value,
                    ethers.utils.parseEther(document.getElementById("buildPrice").value || "0"),
                    { value: ethers.utils.parseEther("50") }
                );
                await tx.wait();
                alert("Deployed!");
                switchTab('marketplace');
            } catch(e) { alert(e.message); }
        }

        async function buyApp(id, price) {
            try {
                const tx = await contract.buyApp(id, { value: ethers.utils.parseEther(price) });
                await tx.wait();
                loadMarketplace();
            } catch(e) { alert(e.message); }
        }

        function filterCategory(cat) { currentFilter = cat; loadMarketplace(); }
        function filterApps() {
            const q = document.getElementById("searchBar").value.toLowerCase();
            document.querySelectorAll(".glass-panel").forEach(el => {
                el.style.display = el.innerText.toLowerCase().includes(q) ? "block" : "none";
            });
        }

        // --- LAUNCHER LOGIC (FIXED) ---
        async function launchApp(id, title, isBlockchain, rawCode = null) {
            const win = document.getElementById('appWindow');
            const frame = document.getElementById('appFrame');
            
            win.classList.remove('hidden');
            
            let codeToRun = rawCode;

            if (isBlockchain) {
                try {
                    const compressed = await contract.getCode(id);
                    if(!compressed) throw new Error("No code found.");
                    codeToRun = LZString.decompressFromBase64(compressed);
                } catch(e) {
                    alert("Error loading app: " + e.message);
                    closeAppWindow();
                    return;
                }
            }

            // Universal Starter Bridge
            const bridge = `
                <style>
                    body { margin: 0; overflow: hidden; background: #000; }
                    #start-btn { 
                        position: fixed; inset: 0; z-index: 9999; 
                        display: flex; align-items: center; justify-content: center; 
                        background: rgba(0,0,0,0.9); color: #0f0; 
                        font-family: monospace; font-size: 24px; cursor: pointer;
                    }
                </style>
                <div id="start-btn" onclick="startSystem()">[ CLICK TO START ]</div>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"><\/script>
                <script>
                    window.ethereum = window.parent.ethereum;
                    function startSystem() {
                        document.getElementById('start-btn').remove();
                        // Try every common entry point
                        if(typeof startGame == 'function') startGame();
                        else if(typeof init == 'function') init();
                        else if(typeof setup == 'function') setup();
                        else if(typeof main == 'function') main();
                        // Force a click on body to wake up audio contexts
                        document.body.click();
                    }
                <\/script>
            `;
            frame.srcdoc = bridge + codeToRun;
        }

        function closeAppWindow() {
            document.getElementById('appWindow').classList.add('hidden');
            document.getElementById('appFrame').srcdoc = "";
        }
    </script>
</body>
</html>
